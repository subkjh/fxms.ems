<?xml version="1.0" encoding="UTF-8" ?>
<queries>

	<resultMap id="RESULT_MAP" javaClass="java.util.HashMap" keyCase="java" />


	<select id="select-trade-list" resultMap="RESULT_MAP">
		<![CDATA[
		select 	a.SEQ						as TRNS_NO							 /*거래번호 */
				, if(a.ENERGY_GROUP_NAME = '압축공기', 'E01', 
					if(a.ENERGY_GROUP_NAME = '스팀', 'E02', 'E03')) 
					 						as ENG_TID							/*에너지ID */
				, a.SOURCE_FACTORY_ID		as SELL_INLO_TID					/*판매설치위치번호 */
				, a.SINK_FACTORY_ID			as BUY_INLO_TID						/*구입설치위치번호 */
				, DATE_FORMAT(a.TRADING_START_DATE, '%Y%m%d%H%i%S') 
											as TRNS_STRT_DTM					/*거래시작일시 */
				, DATE_FORMAT(a.TRADING_END_DATE, '%Y%m%d%H%i%S')		
											as TRNS_FNSH_DTM					/*거래종료일시 */
				, a.BUY_MAX_UNIT_VOLUME		as HOURLY_MAX_CNTRT_TRNS_VOL		/*시간당최대계약거래량 */
		from 	view_tbl_trading_buy 		a
		where 	a.CANCEL_FLAG	= 'N'
		and		a.SEQ >= $trnsNo
		]]>
	</select>

	<select id="select-settlement-list" resultMap="RESULT_MAP">
		<![CDATA[
		select    0									as TRNS_NO                           /*거래번호 */
		        , concat(a.YEAR, a.MONTH)			as CALC_YM                           /*정산년월 */
		        , a.SETTLEMENT_STATUS_CD			as CALC_ST_CD                        /*정산상태코드 */
		        , a.DEPOSIT_CD						as DEAWI_ST_CD                       /*입출금상태코드 */
		        , a.SETTLEMENT_AMOUNT				as CALC_AMT                          /*정산금액 */
		        , a.TOTAL_USING_VOLUME				as TRNS_VOL                          /*거래량 */
		        , a.USING_PRICE_CHARGE				as TRNS_VOL_CHRG                     /*거래량요금 */
		        , a.UNIT_PRICE						as USE_UNIT_PRICE                    /*사용단가 */
		        , a.BASIS_UNIT_PRICE				as BASE_UNIT_PRICE                   /*기준단가 */
		        , a.INTER_UNIT_PRICE				as LINK_UNIT_PRICE                   /*연동단가 */
		        , a.BASIC_PRICE_CHARGE				as BASIC_CHRG                        /*기본요금 */
		        , a.TOTAL_BUY_UNIT_VOLUME			as CNTRT_TRNS_VOL                    /*계약거래량 */
		        , a.EXCESS_CHARGE					as EXCS_CHRG                         /*초과요금 */
		        , a.DEDUCTION_CHARGE				as REDU_CHRG                         /*공제요금 */
		        , a.EMISSION_CHARGE					as GHG_COST                          /*온실가스비용 */
		        , a.VAT_CHARGE						as VAT_COST                          /*부가세비용 */
		        , a.VUP_FEE_CHARGE					as COMM_FAC_COST                     /*공용설비사용 */
		        , a.ORI_SETTLEMENT_AMOUNT			as ORG_CALC_AMT                      /*원래정산금액 */
		        , a.ORI_TOTAL_USING_VOLUME			as ORG_TRNS_VOL                      /*원래거래량 */
		        , a.ORI_USING_PRICE_CHARGE			as ORG_TRNS_VOL_CHRG                 /*원래거래량요금 */
		        , ''								as CORR_MEMO                         /*보정변경사유 */
		        , ''								as CORR_CHG_DATE                     /*보정변경일자 */
		        , ''								as CORR_USER_NO                      /*보정변경자번호 */
		        , ''								as REG_USER_NO                       /*등록사용자번호 */
		        , ''								as REG_DTM                           /*등록일시 */
		        , ''								as CHG_USER_NO                       /*수정사용자번호 */
		        , ''								as CHG_DTM                           /*수정일시 */
		from 	view_tbl_settlement_buy a		 
		where	concat(a.YEAR, a.MONTH) >= $calcYm
		]]>
	</select>

	<select id="select-settlement-buy-list" resultMap="RESULT_MAP">
		<![CDATA[
		select    a.SINK_FACTORY_ID					as PLANT_PID                         /*공장PID */
				, if(a.ENERGY_GROUP_NAME = '압축공기', 'E01', 
					if(a.ENERGY_GROUP_NAME = '스팀', 'E02', 'E03')) 
					 								as ENG_TID							/*에너지ID */		
		        , concat(a.YEAR, a.MONTH)			as CALC_YM                           /*정산년월 */
		        , 'SINK'							as SINK_SOURCE                       /*싱크소스구분 */
		        , a.SETTLEMENT_STATUS_CD			as CALC_ST_CD                        /*정산상태코드 */
		        , a.DEPOSIT_CD						as DEAWI_ST_CD                       /*입출금상태코드 */
		        , a.SETTLEMENT_AMOUNT				as CALC_AMT                          /*정산금액 */
		        , a.TOTAL_USING_VOLUME				as TRNS_VOL                          /*거래량 */
		        , a.USING_PRICE_CHARGE				as TRNS_VOL_CHRG                     /*거래량요금 */
		        , a.UNIT_PRICE						as USE_UNIT_PRICE                    /*사용단가 */
		        , a.BASIS_UNIT_PRICE				as BASE_UNIT_PRICE                   /*기준단가 */
		        , a.INTER_UNIT_PRICE				as LINK_UNIT_PRICE                   /*연동단가 */
		        , a.BASIC_PRICE_CHARGE				as BASIC_CHRG                        /*기본요금 */
		        , a.TOTAL_BUY_UNIT_VOLUME			as CNTRT_TRNS_VOL                    /*계약거래량 */
		        , a.EXCESS_CHARGE					as EXCS_CHRG                         /*초과요금 */
		        , a.DEDUCTION_CHARGE				as REDU_CHRG                         /*공제요금 */
		        , a.EMISSION_CHARGE					as GHG_COST                          /*온실가스비용 */
		        , a.VAT_CHARGE						as VAT_COST                          /*부가세비용 */
		        , a.VUP_FEE_CHARGE					as COMM_FAC_COST                     /*공용설비사용 */
		        , a.ORI_SETTLEMENT_AMOUNT			as ORG_CALC_AMT                      /*원래정산금액 */
		        , a.ORI_TOTAL_USING_VOLUME			as ORG_TRNS_VOL                      /*원래거래량 */
		        , a.ORI_USING_PRICE_CHARGE			as ORG_TRNS_VOL_CHRG                 /*원래거래량요금 */
		        , ''								as CORR_MEMO                         /*보정변경사유 */
		        , ''								as CORR_CHG_DATE                     /*보정변경일자 */
		        , ''								as CORR_USER_NO                      /*보정변경자번호 */
		        , ''								as REG_USER_NO                       /*등록사용자번호 */
		        , ''								as REG_DTM                           /*등록일시 */
		        , ''								as CHG_USER_NO                       /*수정사용자번호 */
		        , ''								as CHG_DTM                           /*수정일시 */
		from 	view_tbl_settlement_buy a		 
		where	concat(a.YEAR, a.MONTH) >= $calcYm
		]]>
	</select>

	<select id="select-settlement-sale-list" resultMap="RESULT_MAP">
		<![CDATA[
		select    a.SOURCE_FACTORY_ID				as PLANT_PID                         /*공장PID */
				, if(a.ENERGY_GROUP_NAME = '압축공기', 'E01', 
					if(a.ENERGY_GROUP_NAME = '스팀', 'E02', 'E03')) 
					 								as ENG_TID							/*에너지ID */		
		        , concat(a.YEAR, a.MONTH)			as CALC_YM                           /*정산년월 */
		        , 'SOURCE'							as SINK_SOURCE                       /*싱크소스구분 */
		        , a.SETTLEMENT_STATUS_CD			as CALC_ST_CD                        /*정산상태코드 */
		        , a.PAYMENT_CD						as DEAWI_ST_CD                       /*입출금상태코드 */
		        , a.SETTLEMENT_AMOUNT				as CALC_AMT                          /*정산금액 */
		        , a.TOTAL_SUPPLY_VOLUME				as TRNS_VOL                          /*거래량 */
		        , a.SUPPLY_PRICE_CHARGE				as TRNS_VOL_CHRG                     /*거래량요금 */
		        , a.UNIT_PRICE						as USE_UNIT_PRICE                    /*사용단가 */
		        , 0									as BASE_UNIT_PRICE                   /*기준단가 */
		        , 0									as LINK_UNIT_PRICE                   /*연동단가 */
		        , 0									as BASIC_CHRG                        /*기본요금 */
		        , 0									as CNTRT_TRNS_VOL                    /*계약거래량 */
		        , 0									as EXCS_CHRG                         /*초과요금 */
		        , 0									as REDU_CHRG                         /*공제요금 */
		        , 0									as GHG_COST                          /*온실가스비용 */
		        , a.VAT_CHARGE						as VAT_COST                          /*부가세비용 */
		        , a.VUP_FEE_CHARGE					as COMM_FAC_COST                     /*공용설비사용 */
		        , a.ORI_SETTLEMENT_AMOUNT			as ORG_CALC_AMT                      /*원래정산금액 */
		        , a.ORI_TOTAL_SUPPLY_VOLUME			as ORG_TRNS_VOL                      /*원래거래량 */
		        , a.ORI_SUPPLY_PRICE_CHARGE			as ORG_TRNS_VOL_CHRG                 /*원래거래량요금 */
		        , ''								as CORR_MEMO                         /*보정변경사유 */
		        , ''								as CORR_CHG_DATE                     /*보정변경일자 */
		        , ''								as CORR_USER_NO                      /*보정변경자번호 */
		        , ''								as REG_USER_NO                       /*등록사용자번호 */
		        , ''								as REG_DTM                           /*등록일시 */
		        , ''								as CHG_USER_NO                       /*수정사용자번호 */
		        , ''								as CHG_DTM                           /*수정일시 */
		from 	view_tbl_settlement_sale a		 
		where	concat(a.YEAR, a.MONTH) >= $calcYm
		]]>
	</select>

	<!-- 거래 내역을 조회한다. ( 2023.07.26 ) -->
	<select id="select-trading-list" resultMap="RESULT_MAP">
		<![CDATA[
		with datas as (
			select 	a.SEQ
					, a.FACTORY_GROUP_ID
					, a.ENERGY_GROUP_ID
					, a.ROOM_NAME 					
					, a.ROOM_START_MONTH 
					, a.ROOM_END_MONTH
					, a.TRADING_MODEL_CD
					, ( select CODE_NAME from tbl_common_code t1 where t1.CODE_GROUP_ID = '43' and t1.CODE_ID = a.TRADING_MODEL_CD )
												as TRADING_MODEL_NM
					, a.UNIT_PRICE_TYPE_CD 
					, ( select CODE_NAME from tbl_common_code t1 where t1.CODE_GROUP_ID = '42' and t1.CODE_ID = a.UNIT_PRICE_TYPE_CD )
												as UNIT_PRICE_TYPE_NM
					, a.SETTLEMENT_TYPE_CD 
					, ( select CODE_NAME from tbl_common_code t1 where t1.CODE_GROUP_ID = '52' and t1.CODE_ID = a.SETTLEMENT_TYPE_CD )
												as SETTLEMENT_TYPE_NM
					, b.TRADING_ROOM_SEQ 
					, b.SOURCE_FACTORY_ID 
					, b.SALE_UNIT_PRICE 
					, b.SALE_UNIT_VOLUME 
					, c.SINK_FACTORY_ID
					, c.TRADING_ROOM_SALE_SEQ
					, c.BUY_START_MONTH
					, c.BUY_END_MONTH 
					, c.BUY_UNIT_VOLUME
					, c.BUY_MAX_UNIT_VOLUME
					, DATE_FORMAT(c.TRADING_DATE , '%Y%m%d%H%i%s') 
												as TRADING_DATE
					, c.SEQ as SEQ2
			from 	tbl_trading_room 		a
					, tbl_trading_room_sale b
					, tbl_trading_room_buy 	c
			where 	a.SEQ 					= b.TRADING_ROOM_SEQ 
			and 	c.TRADING_ROOM_SALE_SEQ = b.SEQ
			and 	a.USE_FLAG  			= 'Y'
			and 	c.CANCEL_FLAG 			= 'N'
			and 	DATE_FORMAT(c.TRADING_DATE , '%Y%m%d%H%i%s') 
											>= $tradingDate
		) 
		select 	a.FACTORY_GROUP_ID				as COMPLEX_TID
				, a.SOURCE_FACTORY_ID			as SELL_PLANT_TID
				, a.SINK_FACTORY_ID				as BUY_PLANT_TID
				, a.ENERGY_GROUP_ID				as ENG_TID
				, a.TRADING_MODEL_CD 			as TRNS_METHD_CD
				, a.TRADING_DATE				as TRNS_DTM
				, concat(a.BUY_START_MONTH, '01000000')
									 			as TRNS_STRT_DTM
				, concat(a.BUY_END_MONTH, '01000000')									 			
												as TRNS_FNSH_DTM
				, a.BUY_UNIT_VOLUME 			as HOURLY_MAX_CNTRT_TRNS_VOL		
				, concat(SEQ, '-', TRADING_ROOM_SEQ, '-', TRADING_ROOM_SALE_SEQ, '-', SEQ2) 	
												as CNTRT_DOC_NUM
				, concat(SEQ, ' ', ROOM_NAME, '/', TRADING_MODEL_NM )
												as TRNS_DESCR
		from 	datas a
		]]>
	</select>
	
		<!-- 거래에 따른 경로 확인용 쿼리 ( 2023.07.26 ) -->
	<select id="select-trading-route-list" resultMap="RESULT_MAP">
		<![CDATA[
		select 	a.TRNS_NO 
				, a.TRNS_ST_CD		as "거래상태"
				, a.ENG_ID			as "에너지"
				, a1.INLO_NAME		as "산단"
				, a2.INLO_NAME		as "판매공장"
				, a3.INLO_NAME		as "구입공장"
				, a.TRNS_STRT_DTM	as "구입시작일시"
				, a.TRNS_FNSH_DTM	as "구입종료일시"
				, a.TRNS_DESCR		as "거래설명"
				, a.HOURLY_MAX_CNTRT_TRNS_VOL
									as "시간당거래량"
				, b.ENG_RT_ID		as "거래경로"
				, b.ENG_RT_DESCR	as "거래경로명"				
		from 	FE_ENG_TRANS_BAS a
					left join FX_CF_INLO a1 on a1.INLO_NO = a.INLO_NO
					left join FX_CF_INLO a2 on a2.INLO_NO = a.SELL_INLO_NO
					left join FX_CF_INLO a3 on a3.INLO_NO = a.BUY_INLO_NO 
				, FE_ENG_RT_BAS b
		where 	a.INLO_NO  		= b.INLO_NO 
		and 	a.SELL_INLO_NO 	= b.STRT_INLO_NO 
		and 	a.BUY_INLO_NO  	= b.FNSH_INLO_NO 
		and		a.ENG_ID		= b.ENG_ID
		]]>
	</select>
</queries>

